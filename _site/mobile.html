<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Mobile Orientation Tracking</title>
		<meta charset="utf-8">
		<link rel="shortcut icon" href="./favicon.ico" type="image/x-icon"/>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: black;
				margin: 0px;
				overflow: hidden;
                color: white;
			}
		</style>
    </head>
    <body>
        <div id="logOutput"></div>
        <script crossorigin="anonymous">
            const initClient = ipAddress => {

                const wsClient = new WebSocket(`ws://${ipAddress}:8080`);

                wsClient.onopen = function () {
                    // connection is opened and ready to use
                    log('on open');
                };

                wsClient.onerror = function (error) {
                    // an error occurred when sending/receiving data
                    log('on error ' + JSON.stringify(error, ["message", "arguments", "type", "name"]));
                };
                
                wsClient.onmessage = function (message) {
                    log('received message: ' + message.data);
                };

                let _deviceOrientation = {};

                window.addEventListener( 'deviceorientation', ev => {
                    _deviceOrientation = event;
                }, false );

                window.addEventListener( 'orientationchange', ev => {
                    const {alpha, beta, gamma} = _deviceOrientation;
                    const msg = JSON.stringify({type:"device-orientation-change", data: {alpha, beta, gamma} });
                    wsClient.send(msg);
                }, false );

                window.setInterval(() => {
                    const {alpha, beta, gamma} = _deviceOrientation;
                    const msg = JSON.stringify({type:"device-orientation-change", data: {alpha, beta, gamma} });
                    wsClient.send(msg);
                }, 100);
            };

            const logOutput = document.getElementById('logOutput');

            const log = msg => {
                const now = new Date();
                const padLeft = value => value<10 ? "0"+value : value;

                logOutput.innerHTML += `<br/>${padLeft(now.getHours())}:${padLeft(now.getMinutes())}:${padLeft(now.getSeconds())} ${msg}`
            }

            fetch('/get-ip-address').then(response => response.text()).then(ipAddress => initClient(ipAddress));
        </script>
    </body>
</html>